<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë””ì§€í„¸ ì„±ì  í™•ì¸ ë° ì„œëª… ì‹œìŠ¤í…œ</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ExcelJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <!-- Signature Pad Library -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
        }
        body {
            background-color: #f8f9fc;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding-bottom: 50px;
        }
        .container { max-width: 900px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); margin-bottom: 20px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #e3e6f0; font-weight: bold; color: var(--primary-color); border-radius: 12px 12px 0 0 !important; }
        
        #signature-pad-container {
            border: 2px dashed #d1d3e2;
            border-radius: 8px;
            background-color: #fff;
            position: relative;
            width: 100%;
            height: 200px;
            margin-top: 15px;
        }
        #signature-pad {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        
        #dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            background: #fff;
        }
        .student-chip {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.85rem;
            border: 1px solid #e3e6f0;
            transition: all 0.2s;
            background-color: #f1f3f9;
        }
        .student-chip.complete { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        
        .hidden { display: none; }
        .info-table th { width: 35%; background-color: #f8f9fc; vertical-align: middle; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-dark">ğŸ“ ë””ì§€í„¸ ì„±ì  í™•ì¸ ì‹œìŠ¤í…œ</h2>
        <p class="text-muted">ë‚˜ì´ìŠ¤ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë°˜/ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ì„œëª…ì„ ì§„í–‰í•˜ì„¸ìš”.</p>
    </div>

    <div class="card" id="step1-card">
        <div class="card-header">1. ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ (ë‚˜ì´ìŠ¤ ì–‘ì‹)</div>
        <div class="card-body">
            <div class="mb-3">
                <input class="form-control" type="file" id="excelFileInput" accept=".xlsx">
                <div class="form-text mt-2">
                    * í—¤ë”: 12í–‰ / ë°ì´í„°: 13í–‰ / Bì—´: ë°˜/ë²ˆí˜¸(ì˜ˆ: 1/1) ê¸°ì¤€
                </div>
            </div>
            <div id="fileInfo" class="hidden alert alert-info py-2 small"></div>
        </div>
    </div>

    <div class="card hidden" id="step2-card">
        <div class="card-header">2. ë³¸ì¸ ì„±ì  í™•ì¸ ë° ì„œëª…</div>
        <div class="card-body">
            <div class="row g-2 mb-4">
                <div class="col-md-5">
                    <input type="text" id="searchNumber" class="form-control" placeholder="ë°˜/ë²ˆí˜¸ (ì˜ˆ: 1/1)">
                </div>
                <div class="col-md-5">
                    <input type="text" id="searchName" class="form-control" placeholder="ì„±ëª… (ì˜ˆ: í™ê¸¸ë™)">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="searchStudent()">ì¡°íšŒ</button>
                </div>
            </div>

            <div id="studentDetail" class="hidden">
                <hr>
                <h5 class="fw-bold mb-3 text-primary">ê°œì¸ ì„±ì  ì •ë³´</h5>
                <div class="table-responsive">
                    <table class="table table-bordered info-table" id="studentDataTable">
                        <!-- JSì—ì„œ ë°ì´í„° ì±„ì›€ -->
                    </table>
                </div>

                <div class="mt-4">
                    <label class="form-label fw-bold">ì„œëª…ë€ (ì•„ë˜ ì¹¸ì— ì„œëª…í•´ ì£¼ì„¸ìš”)</label>
                    <div id="signature-pad-container">
                        <canvas id="signature-pad"></canvas>
                    </div>
                    <div class="mt-2 d-flex justify-content-between">
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSignature()">ë‹¤ì‹œ ì“°ê¸°</button>
                        <button class="btn btn-success" onclick="confirmSignature()">í™•ì¸ ë° ì„œëª… ì™„ë£Œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card hidden" id="admin-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>3. ì„œëª… í˜„í™© ë° íŒŒì¼ ë‚´ë³´ë‚´ê¸°</span>
            <button class="btn btn-danger btn-sm" onclick="resetAll()">ì „ì²´ ë¦¬ì…‹</button>
        </div>
        <div class="card-body">
            <div id="dashboard" class="mb-4">
                <!-- JSì—ì„œ í˜„í™© ì¹© ìƒì„± -->
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-dark btn-lg" onclick="downloadUpdatedExcel()">
                    ìµœì¢… ì„œëª… í¬í•¨ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let workbook = null;
    let worksheet = null;
    let studentsData = [];
    let signatures = {}; 
    let signaturePad = null;
    let colMapping = { number: 2, name: -1, remarks: -1 }; 
    let currentStudentRowIndex = null;

    const HEADER_ROW_INDEX = 12;
    const DATA_START_ROW_INDEX = 13;

    window.onload = () => {
        const canvas = document.getElementById('signature-pad');
        signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgba(255, 255, 255, 0)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    };

    function resizeCanvas() {
        const canvas = document.getElementById('signature-pad');
        if (!canvas) return;
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }

    function getSafeText(cell) {
        if (!cell) return "";
        const val = cell.value;
        if (val === null || val === undefined) return "";
        if (typeof val === 'object' && val.richText) {
            return val.richText.map(t => t.text || "").join("");
        }
        if (typeof val === 'object' && val.result !== undefined) {
            return val.result !== null ? val.result.toString() : "";
        }
        if (typeof val === 'object' && val.text) {
            return val.text.toString();
        }
        return val.toString();
    }

    document.getElementById('excelFileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const arrayBuffer = await file.arrayBuffer();
            workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(arrayBuffer);
            worksheet = workbook.worksheets[0];

            parseExcelStructure();
            loadStudents();
            
            document.getElementById('fileInfo').innerText = `âœ… íŒŒì¼ ë¡œë“œ ì„±ê³µ: ${file.name} (${studentsData.length}ëª… ëŒ€ê¸° ì¤‘)`;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('step2-card').classList.remove('hidden');
            document.getElementById('admin-card').classList.remove('hidden');
            
            updateDashboard();
        } catch (err) {
            console.error(err);
            alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì´ìŠ¤ ì—‘ì…€ íŒŒì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
    });

    function parseExcelStructure() {
        const headerRow = worksheet.getRow(HEADER_ROW_INDEX);
        colMapping = { number: 2, name: -1, remarks: -1 };
        
        headerRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
            const val = getSafeText(cell).trim();
            if ((val.includes('ì„±ëª…') || val.includes('ì´ë¦„')) && colMapping.name === -1) colMapping.name = colNumber;
            if (val.includes('ë¹„ê³ ') && colMapping.remarks === -1) colMapping.remarks = colNumber;
        });

        if (colMapping.name === -1) colMapping.name = 3;
        if (colMapping.remarks === -1) {
            colMapping.remarks = headerRow.actualCellCount || 10;
        }
    }

    function loadStudents() {
        studentsData = [];
        worksheet.eachRow({ includeEmpty: false }, (row, rowNumber) => {
            if (rowNumber >= DATA_START_ROW_INDEX) {
                const num = getSafeText(row.getCell(colMapping.number)).trim();
                const name = getSafeText(row.getCell(colMapping.name)).trim();
                if (num || name) {
                    studentsData.push({
                        rowIndex: rowNumber,
                        number: num,
                        name: name
                    });
                }
            }
        });
    }

    function searchStudent() {
        const numInput = document.getElementById('searchNumber').value.trim(); 
        const nameInput = document.getElementById('searchName').value.trim();

        if (!numInput || !nameInput) {
            alert('ë°˜/ë²ˆí˜¸ì™€ ì„±ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
        }

        const student = studentsData.find(s => s.number === numInput && s.name === nameInput);

        if (student) {
            displayStudent(student);
        } else {
            alert('ì¼ì¹˜í•˜ëŠ” í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në°˜/ë²ˆí˜¸(ì˜ˆ: 1/1)ì™€ ì„±ëª…ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.');
            document.getElementById('studentDetail').classList.add('hidden');
        }
    }

    function displayStudent(student) {
        currentStudentRowIndex = student.rowIndex;
        const detailDiv = document.getElementById('studentDetail');
        const table = document.getElementById('studentDataTable');
        table.innerHTML = '';

        const row = worksheet.getRow(student.rowIndex);
        const headerRow = worksheet.getRow(HEADER_ROW_INDEX);

        headerRow.eachCell({ includeEmpty: true }, (headerCell, colNum) => {
            const headText = getSafeText(headerCell).trim();
            if (headText && colNum !== colMapping.remarks) {
                const cellVal = getSafeText(row.getCell(colNum)) || '-';
                const tr = document.createElement('tr');
                tr.innerHTML = `<th class="text-secondary small">${headText}</th><td class="fw-bold">${cellVal}</td>`;
                table.appendChild(tr);
            }
        });

        detailDiv.classList.remove('hidden');
        signaturePad.clear();
        setTimeout(resizeCanvas, 50); 
    }

    function clearSignature() {
        signaturePad.clear();
    }

    function confirmSignature() {
        if (signaturePad.isEmpty()) {
            alert('ì„œëª…ë€ì— ì„œëª…í•´ ì£¼ì„¸ìš”.');
            return;
        }

        const dataURL = signaturePad.toDataURL('image/png');
        signatures[currentStudentRowIndex] = dataURL;

        alert(`í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        document.getElementById('searchNumber').value = '';
        document.getElementById('searchName').value = '';
        document.getElementById('studentDetail').classList.add('hidden');
        
        updateDashboard();
    }

    function updateDashboard() {
        const dashboard = document.getElementById('dashboard');
        dashboard.innerHTML = '';

        studentsData.forEach(s => {
            const chip = document.createElement('div');
            const isSigned = signatures[s.rowIndex] ? true : false;
            chip.className = `student-chip ${isSigned ? 'complete' : ''}`;
            chip.innerText = `${s.number} ${s.name}`;
            dashboard.appendChild(chip);
        });
    }

    async function downloadUpdatedExcel() {
        if (Object.keys(signatures).length === 0) {
            if (!confirm('ì™„ë£Œëœ ì„œëª…ì´ ì—†ìŠµë‹ˆë‹¤. ì›ë³¸ íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        }

        const btn = event.target;
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'íŒŒì¼ ìƒì„± ì¤‘...';

        try {
            for (const rowIndex in signatures) {
                const base64 = signatures[rowIndex].split(',')[1];
                const imageId = workbook.addImage({
                    base64: base64,
                    extension: 'png',
                });

                // ì„œëª… ì´ë¯¸ì§€ê°€ ì…€ì— ê½‰ ì°¨ë„ë¡ ì„¤ì • ìˆ˜ì •
                worksheet.addImage(imageId, {
                    tl: { col: colMapping.remarks - 1, row: parseInt(rowIndex) - 1 },
                    br: { col: colMapping.remarks, row: parseInt(rowIndex) },
                    editAs: 'twoCells' // ì…€ í¬ê¸°ì— ë§ì¶° ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆ
                });
            }

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì„±ì í™•ì¸ì™„ë£Œ_${new Date().toLocaleDateString()}.xlsx`;
            a.click();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            console.error(err);
            alert('ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    function resetAll() {
        if (confirm('ëª¨ë“  ë°ì´í„°ì™€ ì„œëª… í˜„í™©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            location.reload();
        }
    }
</script>

</body>
</html>
